# Exercise 1: Registering an application in Azure Active Directory

## Task 1: Open the Azure portal

1.On the taskbar, select the Microsoft Edge icon.

2.In the open browser window, navigate to the Azure portal (portal.azure.com).

3.Enter the email address for your Microsoft account.

4.Select Next.

5.Enter the password for your Microsoft account.

6.Select Sign in.

Note: If this is your first time signing in to the Azure Portal, a dialog box will appear offering a tour of the portal. Select Get Started to begin using the portal.

## Task 2: Create an Active Directory tenant

In this task, you will create a new Active Directory organization so you will understand the steps involved. Even though you will be creating a new Azure Active Directory organization, the remainder of the tasks will have you continue to work in the existing organization that was provided with your Azure portal.

## Create an Azure AD organization

1.Expand the left navigation pane, select Azure Active Directory.

2.Select Create a tenant located in the right side of the portal.

3.From the Basics tab, perform the following actions:

In the Select a tenant type section, select Azure Active Directory.

Select Next: Configuration.

![010101](evidenciasFotos/010101.PNG)

![010102](evidenciasFotos/010102.PNG)

![010103](evidenciasFotos/010103.PNG)

![010104](evidenciasFotos/010104.PNG)

### Task 3: Create a user in new Active Directory tenant

In this task, you will create a user in the new Active Directory tenant you just created in the previous steps. This user account will be used later in an exercise used for adding guest users to a single organization.

1.From the Active Directory page (Contoso Marketing Company), select Users.

2.Select New user.

3.Ensure Create user is selected.

4.On the New user page, enter information for this user:

- User name: testuser

- Name: Test User

- First Name: Test

- Last Name: User

- Password: Auto-generate passwordï¿½Select Show password. Copy the autogenerated password provided in the Password box. You'll need to give this password to the user to sign in for the first time.

  5.Select Create.

  6.Launch a New InPrivate Window browser session.

  7.Test new user in Azure portal and change password:

i. Navigate to the Azure portal, https://portal.azure.com in the InPrivate browser session.

ii. Sign in with your new testuser@contosomarketingxx@onmicrosoft.com account.

iii. You will be prompted to change the password. Paste the auto-generated password you copied and paste into the Current password field.

iv. Set the password as desired.

v. Save the username and password so you will remember the credentials for using it later in this lab.

![010105](evidenciasFotos/010105.PNG)

![010106](evidenciasFotos/010106.PNG)

![010107](evidenciasFotos/010107.PNG)

### Task 4: Register an application

In this task, you will switch Active Directory tenants and then continue with registering an application into the default

#### Switch Azure AD Directory

1. Select the Directory + subscription icon.

Azure portal top menu bar showing the Directory and subscription icon that needs to be clicked on.

2. Select Contoso.

Azure portal top menu bar showing the Directory and subscription icon that needs to be clicked on.

You should be redirected to the Active Directory page for Contoso. If it redirected you to the default Azure portal landing page, then follow the steps below to navigate back to Azure Active Directory:

You will be redirected to the Azure portal landing page where you should now see an Azure Active Directory button available.

Select the Azure Active Directory icon. If you do not have the icon: expand the left navigation pane, select Azure Active Directory.

Azure portal top menu bar showing the Directory and subscription icon that needs to be clicked on.

Register a new application
On the left menu, navigate to App registrations.

Select New Registration.

From the Register an application pane, perform the following actions:

In the Name text box, enter the value ContosoApp.

In the Supported account type section, select Accounts in this organizational directory only.

Leave the Redirect URI (optional) as blank.

Register an application screen displaying ContosoApp for name, Account in this organization directory only selected and Redirect URI optional text field is left blank.

Select Register. The application overview page is displayed.

![010108](evidenciasFotos/010108.PNG)

![010109](evidenciasFotos/010109.PNG)

![010110](evidenciasFotos/010110.PNG)

### Task 5: Branding of the application

On the left menu, navigate to Branding.

Verify that you can personalize branding by providing a logo, home page URL, terms of service URL, and a privacy statement URL.

ContosoApp branding pane displaying options for uploading a logo, setting the home page URL, terms of service URL, and a privacy statement URL.

This exercise is now complete.

![010111](evidenciasFotos/010111.PNG)

## Exercise 2: Implementing authentication

This exercise will demonstrate the different account types that are used within the Microsoft identity platform.

Note: This exercise demonstrates signing into a web application using two different accounts. These two accounts will come from two organizations, one of them being the organization where the Azure AD application is registered. Therefore, in order to complete the exercise, you'll need access to two user accounts in different Azure AD directories.

### Task 1: Create application that only allows single organization sign in

In this task, you will register an application in the Azure portal that allows users from the current organization to sign in.

Register a single-tenant Azure AD application

1.  From the Azure portal https://portal.azure.com, navigate to Azure Active Directory.

2.  Select Manage > App registrations in the left-hand navigation.

3.  On the App registrations page, select New registration.

4.  On the Register an application page, set the values as follows:

        Name: Hello ASPNET Core Identity 01

        Supported account types: Accounts in this organizational directory only (Single tenant)

        Register an application for Hello ASPNET Core Identity 01

5.  Select Register to create the application.

6.  On the Hello ASPNET Core Identity 01 page, copy the values Application (client) ID and Directory (tenant) ID; you'll need these values later in this exercise.

        Hello ASPNET Core Identity 01 overview page with tenant id and client id.

7.  On the Hello ASPNET Core Identity 01 page, select the Add a Redirect URI link under the Redirect URIs.

8.  Locate the section Redirect URIs and add the following two URLs:

    https://localhost:3007

    https://localhost:3007/signin-oidc

9.  Add the following Logout URL: https://localhost:3007/signout-oidc

10. Locate the section Implicit grant and select both Access tokens and ID tokens. This tells Azure AD to return these tokens the authenticated user if requested.

11. Select Save when finished setting these values.

Hello ASPNET Core Identity 01 Authentication settings page.
his exercise is now complete.

![010201](evidenciasFotos/010201.PNG)

![010202](evidenciasFotos/010202.PNG)

![010203](evidenciasFotos/010203.PNG)

![010204](evidenciasFotos/010204.PNG)

### Task 2: Create a single organization ASP.NET core web application

In this first application, you'll create an ASP.NET Core web application that allows users from the current organization to sign in and display their information.

Open your command prompt, navigate to a directory where you want to save your work, create a new folder, and change directory into that folder. For example:

Cd c:/LabFiles
md SingleOrg
cd SingleOrg
Execute the following command to create a new ASP.NET Core MVC web application:

dotnet new mvc --auth SingleOrg
Open the folder in Visual Studio code by executing from the project directory: code .

Configure the web application with the Azure AD application you created
Locate and open the ./appsettings.json file in the ASP.NET Core project.

Set the AzureAd.Domain property to the domain of your Azure AD tenant where you created the Azure AD application (for example: contoso.onmicrosoft.com).

Set the AzureAd.TenantId property to the Directory (tenant) ID you copied when creating the Azure AD application in the previous step.

Set the AzureAd.ClientId property to the Application (client) ID you copied when creating the Azure AD application in the previous step.

Update the web application's launch configuration
Locate and open the ./Properties/launchSettings.json file in the ASP.NET Core project.

Set the iisSettings.iisExpress.applicationUrl property to https://localhost:3007.

Set the iisSettings.iisExpress.sslPort property to 3007.

Update the user experience
Finally, update the user experience of the web application to display all the claims in the OpenID Connect ID token.

Locate and open the ./Views/Home/Index.cshtml file.

Add the following code to the end of the file:

` @if (User.Identity.IsAuthenticated)
{

<div>
    <table cellpadding="2" cellspacing="2">
        <tr>
            <th>Claim</th>
            <th>Value</th>
        </tr>
        @foreach (var claim in User.Claims)
        {
            <tr>
                <td>@claim.Type</td>
                <td>@claim.Value</td>
            </tr>
        }
    </table>
</div>
} `

![010205](evidenciasFotos/010205.PNG)

![010206](evidenciasFotos/010206.PNG)

![010207](evidenciasFotos/010207.PNG)

![010208](evidenciasFotos/010208.PNG)

### Task 3: Build and test the single organization web app

Execute the following command in a command prompt to compile and run the application:

dotnet build
dotnet run
Open a browser and navigate to the url https://localhost:5001. The web application will redirect you to the Azure AD sign in page.

Sign in using a Work and School account from your Azure AD directory. Azure AD will redirect you back to the web application. Notice some of the details from the claims included in the ID token.

Hello ASPNET Core Identity 01 application running displaying authenticated user informatoin.

Take special note of the tenantid and upn claim. These claims indicate the ID of the Azure AD directory and ID of the user that signed in. Make a note of these values to compare them to other options in a minute.

Now try logging in as a user from a different organization. Select the Sign out link in the top left. Wait for Azure AD and the web application signs out the current user. When the web application reloads, repeat the sign in process, except this time try signing in as a user from a different organization or use a Microsoft Account.

Notice Azure AD will reject the user's sign in, explaining that the user's account doesn't exist in the current tenant.

Stop the web server by pressing CTRL+C in the command prompt.

![010209](evidenciasFotos/010209.PNG)

![010210](evidenciasFotos/010210.PNG)

### Task 4: Create application that allows any organization's users to sign in

In this task, you will register an application in the Azure portal that allows users from any organization or Microsoft Accounts to sign in.

Register a multi-tenant Azure AD application
From the Azure portal https://portal.azure.com, navigate to Azure Active Directory.

Select Manage > App registrations in the left-hand navigation.

On the App registrations page, select New registration.

On the Register an application page, set the values as follows:

Name: Hello ASPNET Core Identity 02

Supported account types: Accounts in any organizational directory only (Any Azure AD directory - Multitenant)

Register an application page with Accounts in any organizational directory selected.

Select Register to create the application.

On the Hello ASPNET Core Identity 02 page, copy the values Application (client) ID and Directory (tenant) ID; you'll need these values later in this exercise.

On the Hello ASPNET Core Identity 02 page, select the Add a Redirect URI link under the Redirect URIs.

Locate the section Redirect URIs and add the following two URLs:

https://localhost:3007

https://localhost:3007/signin-oidc

Add the following Logout URL: https://localhost:3007/signout-oidc

Locate the section Implicit grant and select both Access tokens and ID tokens. This tells Azure AD to return these tokens the authenticated user if requested.

Select Save when finished setting these values.

Register an application page with Accounts in any organizational directory selected.

![010211](evidenciasFotos/010211.PNG)

![010212](evidenciasFotos/010212.PNG)

![010213](evidenciasFotos/010213.PNG)

###Task 5: Create a multiple organization ASP.NET core web application
In this second application, you'll create an ASP.NET Core web application that allows users from any organization or Microsoft Accounts to sign in and display their information.

Open your command prompt, navigate to a directory where you want to save your work, create a new folder, and change directory into that folder. For example:

Cd c:/LabFiles
md MultiOrg
cd MultiOrg
Execute the following command to create a new ASP.NET Core MVC web application:

dotnet new mvc --auth MultiOrg
Open the folder in Visual Studio code by executing from the project directory: code .

Configure the web application with the Azure AD application you created
Locate and open the ./appsettings.json file in the ASP.NET Core project.

Set the AzureAd.ClientId property to the Application (client) ID you copied when creating the Azure AD application in the previous step.

Update the web application's launch configuration
Locate and open the ./Properties/launchSettings.json file in the ASP.NET Core project.

Set the iisSettings.iisExpress.applicationUrl property to https://localhost:3007.

Set the iisSettings.iisExpress.sslPort property to 3007.

Update the user experience
Finally, update the user experience of the web application to display all the claims in the OpenID Connect ID token.

Locate and open the ./Views/Home/Index.cshtml file.

Add the following code to the end of the file:

@if (User.Identity.IsAuthenticated)
{

<div>
    <table cellpadding="2" cellspacing="2">
        <tr>
            <th>Claim</th>
            <th>Value</th>
        </tr>
        @foreach (var claim in User.Claims)
        {
            <tr>
                <td>@claim.Type</td>
                <td>@claim.Value</td>
            </tr>
        }
    </table>
</div>
}
Save the above all changes.

![010214](evidenciasFotos/010214.PNG)

![010215](evidenciasFotos/010215.PNG)

### Task 6: Build and test the multiple organization web app

Execute the following command in a command prompt to compile and run the application:

dotnet build
dotnet run
Open a browser and navigate to the url https://localhost:5001. The web application will redirect you to the Azure AD sign in page.

Sign in using a Work and School account from your Azure AD directory. Azure AD will redirect you back to the web application. Notice some of the details from the claims included in the ID token.

ASP.NET applicaiton running in browser.

Take special note of the tenantid and upn claim. These indicate the ID of the Azure AD directory and ID of the user that signed in. Make a note of these values to compare them to other options in a minute.

Now try logging in as a user from a different organization. Select the Sign out link in the top left. Wait for Azure AD and the web application signs out the current user.

This time, the user is prompted to first trust the application:

Permission requested accept dialog for external user.

Select Accept.

Notice the web application's page loads with different claims, specifically for the tenantid and upn claim. This indicates the user is not from the current directory where the Azure AD application is registered:

External organization user logged into web application and displaying user's information.

Stop the web server by going back to the running project in Visual Studio Code. From the Terminal, press CTRL+C in the command prompt.

![010216](evidenciasFotos/010216.PNG)

![010217](evidenciasFotos/010217.PNG)

![010218](evidenciasFotos/010218.PNG)

# Exercise 3: Implementing application that supports B2B

This exercise will demonstrate to the user how to configure and implement an application that supports B2B. Note: This exercise demonstrates signing into a web application using three different accounts. These three accounts will come from two organizations, one of them being the organization where the Azure AD application is registered. Therefore, in order to complete the exercise, you'll need access to two user accounts in different Azure AD directories.

### Task 1: Create a single-tenant Azure AD application

In this task, you'll create an Azure AD application that allows users from the current organization to sign in.

Register a single-tenant Azure AD application
From the Azure portal https://azure.portal.com, navigate to Azure Active Directory.

Select Manage > App registrations in the left-hand navigation.

On the App registrations page, select New registration.

On the Register an application page, set the values as follows:

Name: Hello ASPNET Core Identity 03

Supported account types: Accounts in this organizational directory only (Single tenant)

Register an application page for accounts in this organizational directory only.

Select Register to create the application.

On the Hello ASPNET Core Identity 03 page, copy the values Application (client) ID and Directory (tenant) ID; you'll need these values later in this exercise.

On the Hello ASPNET Core Identity 03 page, select the Add a Redirect URI link under the Redirect URIs.

Locate the section Redirect URIs and add the following two URLs:

https://localhost:3007

https://localhost:3007/signin-oidc

Add the following Logout URL: https://localhost:3007/signout-oidc

Locate the section Implicit grant and select both Access tokens and ID tokens. This tells Azure AD to return these tokens the authenticated user if requested.

Select Save when finished setting these values.

![010301](evidenciasFotos/010301.PNG)

![010302](evidenciasFotos/010302.PNG)

![010303](evidenciasFotos/010303.PNG)

## Task 2: Create a single organization ASP.NET core web application

In this application, you'll create an ASP.NET Core web application that allows users from the current organization to sign in and display their information.

Open your command prompt, navigate to a directory where you want to save your work, create a new folder, and change directory into that folder. For example:

Cd c:/LabFiles
md SingleOrgGuests
cd SingleOrgGuests
Execute the following command to create a new ASP.NET Core MVC web application:

dotnet new mvc --auth SingleOrg
Open the folder in Visual Studio code by executing from the project directory: code .

Configure the web application with the Azure AD application you created
Locate and open the ./appsettings.json file in the ASP.NET Core project.

Set the AzureAd.Domain property to the domain of your Azure AD tenant where you created the Azure AD application (for example: contoso.onmicrosoft.com).

Set the AzureAd.TenantId property to the Directory (tenant) ID you copied when creating the Azure AD application in the previous step.

Set the AzureAd.ClientId property to the Application (client) ID you copied when creating the Azure AD application in the previous step.

Update the web application's launch configuration
Locate and open the ./Properties/launchSettings.json file in the ASP.NET Core project.

Set the iisSettings.iisExpress.applicationUrl property to https://localhost:3007.

Set the iisSettings.iisExpress.sslPort property to 3007.

Update the user experience
Finally, update the user experience of the web application to display all the claims in the OpenID Connect ID token.

Locate and open the ./Views/Home/Index.cshtml file.

Add the following code to the end of the file:

@if (User.Identity.IsAuthenticated)
{

<div>
    <table cellpadding="2" cellspacing="2">
        <tr>
            <th>Claim</th>
            <th>Value</th>
        </tr>
        @foreach (var claim in User.Claims)
        {
            <tr>
                <td>@claim.Type</td>
                <td>@claim.Value</td>
            </tr>
        }
    </table>
</div>
}
Save the above all changes.

![010304](evidenciasFotos/010304.PNG)

![010305](evidenciasFotos/010305.PNG)

### Task 3: Build and test the app

Execute the following command in a command prompt to compile and run the application:

dotnet build
dotnet run
Open a browser and navigate to the url https://localhost:5001. The web application will redirect you to the Azure AD sign in page.

Sign in using a Work and School account from your Azure AD directory. Azure AD will redirect you back to the web application. Notice some of the details from the claims included in the ID token.

User logged into web application with page displaying user's information.

Take special note of the tenantid and upn claim. These claims indicate the ID of the Azure AD directory and ID of the user that signed in. Make a note of these values to compare them to other options in a minute.

Now try logging in as a user from a different organization. Select the Sign out link in the top left. Wait for Azure AD and the web application signs out the current user. When the web application reloads, repeat the sign in process, except this time try signing in as a user from a different organization or use a Microsoft Account.

Notice Azure AD will reject the user's sign in, explaining that the user's account doesn't exist in the current tenant.

Rejected user sign in dialog displaying error message.

Before this user can access this application, they need to be added as a guest into the Azure AD directory where the application was registered. Proceed with the next task to invite a guest user to your organization.

![010306](evidenciasFotos/010306.PNG)

![010307](evidenciasFotos/010307.PNG)

![010308](evidenciasFotos/010308.PNG)

### Task 4: Invite a guest user from another organization

In this task, you will configure your Active Directory tenant to allow external users and then will invite a guest user from another Active Directory organization.

From the Azure portal, navigate to Azure Active Directory.

In the left-hand navigation, select User.

Examine the external user settings for available to administrators by selecting User Settings and then Manage external collaboration settings.

Azure Active Directory admin center displaying user settings page with link to configure external users access.

Notice that administrators can configure the Azure AD directory so guest users have limited rights compared to other users, and who can invite guest users.

Azure Active Directory admin center displaying external collaboration settings page.

Now let's invite a guest user. Select All users in the left-hand navigation, and then select New guest user:

On the New user page, select Invite user and then add the guest user's information:

Name: Test User

Email address: Type the email address of the new user you created in Exercise 1 Task 3. For example: testuser@contosomarketing001.onmicrosoft.com

New user page with settings for inviting new user from external organization.

Select Invite to automatically send the invitation to the guest user.

Now let's try to sign in with the user. In the browser, navigate to https://localhost:5001.

This time, after successfully logging in, the user's Azure AD directory will prompt the user to grant the application's Azure AD directory permissions to sign in as the user and obtain basic information about the user.

Azure Active Directory admin center displaying external collaboration settings page.

Take note of what is happening at this point. The original Azure AD directory is not signing in the user, rather the user has been redirected to sign in with their Azure AD directory. Once they sign in, their Azure AD directory will provide a token to our directory that is used to verify the user is authenticated and authorized the application to obtain their basic profile information. It then created a new access token that can be used by our ASP.NET Core web application.

After selecting Accept, the user is taken to our ASP.NET application. Notice the difference in some of the claims.

The identityprovider claim is the ID of the Azure AD directory that authenticated the user. This claim is the user's Azure AD directory

The tenantid claim is the ID of the Azure AD directory our application is registered in. Notice this value is not the same as the identityprovider claim, indicating the user's identity is in one directory while they have been added as a guest user to another Azure AD directory.

External guest user signed into web application with page displaying logged in user info.

Stop the web server by going back to the running project in Visual Studio Code. From the Terminal, press CTRL+C in the command prompt.

![010309](evidenciasFotos/010309.PNG)

![010310](evidenciasFotos/010310.PNG)

## Exercise 4: Configuring permissions to consume an API

In this exercise, you'll learn how to configure an application to expose a new scope to make it available to client applications.

### Task 1: Navigate to an application to configure

In the left-hand navigation pane of the Azure portal, select the Azure Active Directory service and then select App registrations.

Find and select the application you want to configure such as ContosoApp. Once you've selected the app, you'll see the application's Overview or main registration page.

Navigate to Expose an API.

![010401](evidenciasFotos/010401.PNG)
